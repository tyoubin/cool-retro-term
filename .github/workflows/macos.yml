name: macOS Build

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt 5
        run: |
          brew install qt@5
          echo "$(brew --prefix qt@5)/bin" >> $GITHUB_PATH

      - name: Compile
        run: |
          qmake -r
          make -j$(sysctl -n hw.ncpu)

      - name: Deploy (Prepare Bundle)
        run: |
          # Bundles frameworks and fixes the plugin link. 
          # We do NOT use -dmg here.
          macdeployqt cool-retro-term.app \
            -verbose=1 \
            -qmldir=. \
            -executable=cool-retro-term.app/Contents/PlugIns/QMLTermWidget/libQMLTermWidget.dylib

      - name: Sign Bundle (Ad-hoc)
        run: |
          # Recursively sign frameworks and plugins first
          find cool-retro-term.app/Contents/Frameworks -name "*.framework" -prune -exec codesign --force --sign - --preserve-metadata=identifier,entitlements "{}" \;
          find cool-retro-term.app/Contents/PlugIns -name "*.dylib" -exec codesign --force --sign - --preserve-metadata=identifier,entitlements "{}" \;
          
          # Sign the main application last
          codesign --force --sign - --deep cool-retro-term.app
      
      - name: Prepare Artifact
        run: |
          # create a staging directory so the zip contains the .app folder, not just its contents
          mkdir release
          mv cool-retro-term.app release/

      - name: Upload App
        uses: actions/upload-artifact@v4
        with:
          name: CoolRetroTerm-macOS
          path: release/
